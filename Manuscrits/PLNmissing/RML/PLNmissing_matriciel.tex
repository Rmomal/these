\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, mathtools}
\usepackage{amsfonts, dsfont}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{empheq}

\newcommand*\widefbox[1]{\fbox{\hspace{3em}#1\hspace{3em}}}

\newcommand*\lesswidefbox[1]{\fbox{\hspace{2em}#1\hspace{2em}}}

\providecommand\given{} % is redefined in \Set
\newcommand\SetSymbol[1][]{\nonscript\:#1\vert\nonscript\:}
%\usepackage[mathcal]{eucal}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}

\setlength\parindent{0pt}
\author{Raphaelle Momal}
\title{PLN with missing actor}


\newcommand{\Esp}{\mathds{E}}
\begin{document}
\maketitle


We had: 
$$ p(Y,Z,T) = p(T)p(Z|T)p(Y|Z)$$
$$ \Esp(\log p(Y,Z,T)|Y) \approx \sum_{1 \leq j < k \leq p} P_{jk} \log\left(\beta_{jk} \hat{\psi}_{jk}\right) - \log B + cst$$

We want to add a hidden layer of unobserved data, indexed by H.

$$ p(Y,Z_O,Z_H,T)$$
\section{PLNmissing peculiarities: Model and distributions}
$$\left\{\begin{array}{rl}
T & \sim\prod_{jk \in T} \beta_{jk}/B \\\\

Z|T& \sim\mathcal{N}(0,\Sigma_T)\\\\

Y|Z&\sim\mathcal{P}( \exp( Z+...) )
\end{array} \right.$$

\paragraph{Marginals}
\begin{align*}
(Z_O,Z_H) &\sim \sum_{T \in \mathcal{T}} p(T) \mathcal{N}(0,\Sigma_T) \\
\end{align*}

\paragraph{Conditional on T:}
\begin{align*}
(Z_O,Z_H)|T & \sim\mathcal{N}(0,\Sigma_T)\\
Z_O|T & \sim\mathcal{N}(0,\Omega_{Tm}^{-1})\\
Z_H|T & \sim\mathcal{N}(0,\Omega_{TH}^{-1})
\end{align*}
With $ \Omega_{Tm} =\Sigma_{TO}^{-1} =  \Omega_{TO} - \Omega_{TOH}\Omega_{TH}^{-1}\Omega_{THO}$


\paragraph{Conditional on observed data:\\}


$Z_O$ decouples $Z_H$ and $Y_O$, we will never need $Z_H|Y_O$.
$$ p(Z|Y_O) = p(Z_O,Z_H | Y_O) = p(Z_H|Z_O) \: p(Z_O|Y_O) $$


VEM on observed data: $$Z_O|Y_O \approx \widetilde{Z}_O \sim \mathcal{N}(m,S)$$

\underline{ Hypothesis:}
$$ Z_O|Y,T \sim \mathcal{N}(m_T,S_T)$$

Model for the hidden part: $$Z_H|Z_O,T \sim \mathcal{N}(\mu_{H|O,T}, \Omega_{TH|O}^{-1})$$ 

\begin{itemize}
\item $\Omega_{TH|O}^{-1} = \Sigma_{TH} -\Sigma_{THO}\Sigma_{TO}^{-1}\Sigma_{TOH} = \Omega_{TH}^{-1}$, 

\item$ \displaystyle\begin{aligned}[t]
\mu_{H|O,T} &= \Sigma_{THO}\Sigma_{TO}^{-1}((Z_O)-\underbrace{\mu_{Z_O|T}}_{0}) \\
 &= -\Omega_{TH}^{-1}\Omega_{TOH}((Z_O))
\end{aligned}$\\
\end{itemize}


\paragraph{Joint:}
\begin{align*}
p(Y,Z,T)& = p(T) \: p(Z|T) \: p(Y|Z) \\
&= p(T)\: p(Z_O,Z_H|T) \: p(Y|Z_O,Z_H) \\
&= p(T) \: p(Z_O|T) \: p(Z_H | Z_O,T)  \: p(Y|Z_O)
\end{align*} 

\section{Inference strategy}
$$p(Y,Z,T)= p(T) \: p(Z_O|T) \: p(Z_H | Z_O,T)  \: \underbrace{p(Y|Z_O)}_{\text{do not depend on T}}$$
\subsection{Observed count data Y}
This part aims at maximizing the likelihood of count data under the PLN model. 
$$p(Y|Z_O,Z_H) = p(Y|Z_O)$$
\subsection{Latent Gaussian layer Z}
This part aims at maximizing the underlying random tree of the Gaussian latent layer.
$$p(Z_O,Z_H,T) = p(T) \: p(Z_O|T) \: p(Z_H | Z_O,T)$$
\section{EM algorithm: E step}

Remarks:
\begin{itemize}
\item When all is observed we do MLE with EMtree, and in formulas $\psi$ contained maximized expression for $p(Z \mid Y)$. Here with missing data MLE is not possible but we might end up with a $\Psi$ gathering information about $ p(Z_O,Z_H|T,Y_O)$
\item The PLN gives us sufficient statistic for the Gaussian latent layer.There should be no problem using Genevieve's formulas until the very end where they should be conditioned on $Y_O$.
\item There exist no $Y_H$ variable. This is because In the latent variable paradigm, observed vraiables are modelled thanks to latent unobserved ones. Hence observed count data $Y$ is only $Y_O$, modelled thanks to $Z$ which structure includes a  missing part.
\item how many times to count an edge/vertices in sums 
\item do not forget the sum on all samples
\end{itemize}



We do not separate the Z vector:
$$p(Z_O,Z_H,T) = p(T) \: p(Z_O,Z_H|T)$$


\subsection{Determinent of $\Omega_T$:\\}
$\Omega_T$ is decomposable along the tree structure. Denoting $c\in\mathcal{C}$ the cliques, $s\in \mathcal{S}$ the separator with multiplicity $\nu(s)$ and $[.]^\Gamma$ the O-completed matrix of size $(p+r)\times(p+r)$:
\begin{align*}
\Omega_T &= \sum_{c\in \mathcal{C}} [\Omega_{Tc}]^\Gamma - \sum_{s \in\mathcal{S}} \nu(s)[\Omega_{Ts}]^\Gamma\\
&= \sum_{jk \in T} [\Omega_{Tjk}]^\Gamma - \sum_j (deg(j)-1)[\Omega_{Tjj}]^\Gamma
\end{align*}

Hence, following Lauritzen p145, for all $(j,k) \in \{1,...,p+r\}^2$:
\begin{align*}
|\Omega_T| &= \dfrac{\prod_{jk \in T} |\Omega_T[jk,jk]|}{\prod_j (\omega_{Tjj})^{deg(j)}} \times \prod_j \omega_{Tjj}\\
&=\prod_j \omega_{Tjj} \times \prod_{jk \in T} \dfrac{\omega_{Tjj}\omega_{Tkk}-(\omega_{Tjk})^2}{\omega_{Tjj}\omega_{Tkk}}
\end{align*}


\begin{empheq}[box=\widefbox]{align*}
\log|\Omega_T|  &= \sum_j \log(\omega_{Tjj}) + \sum_{j<k} \mathds{1}\{jk \in T\}\log\left( 1- \frac{\omega_{Tjk} ^2}{\omega_{Tjj}\omega_{Tkk}}\right)
\end{empheq}

 

\subsection{Squared form terms:\\}
Careful nesting of conditionnements and trace trick:
\begin{align*}
\Esp\left[ Z^T \Omega_T Z \,\middle\vert\,  Y\right] &= \Esp\left[\Esp\left[ Z^T \Omega_T Z \,\middle\vert\,  Z_O,T\right] \,\middle\vert\,  Y\right]\\
&=\Esp\left[\Esp\left[ Tr(Z^T Z\Omega_T ) \,\middle\vert\,  Z_O,T\right] \,\middle\vert\,  Y\right]\\
\end{align*}

\subsection{Surrogate quantity}

For $n$ samples:
\begin{align*}
Q&= \sum_{i=1}^{n} \Esp[\log p(Z_O,Z_H,T) | Y ] \\
&= \sum_i  \Esp[\log p(T)+\log p(Z_O,Z_H|T)|Y] \\
  &=\sum_i \Esp\left[\sum_{jk \in T} \log \beta_{jk} - \log B + \frac{1}{2} \log|\Omega_T| - \frac{1}{2} Z_i^T \Omega_T Z_i\,\middle\vert\,  Y\right]\\
  &=n \;\sum_{j<k} \Esp\left[\mathds{1}\{jk\in T\} \log \beta_{jk}  \,\middle\vert\,  Y\right]- \log B +\frac{n}{2}  \Esp\left[\log|\Omega_T| \,\middle\vert\,  Y\right] - \frac{n}{2} \Esp\left[ Z^T \Omega_T Z \,\middle\vert\,  Y\right]\\
  &=  \sum_{j<k} \mathds{P}\{jk\in T \mid Y\}\left( n \log \beta_{jk} + \frac{n}{2}\log\left( 1- \frac{\omega_{Tjk} ^2}{\omega_{Tjj}\omega_{Tkk}}\right)\right) -\log B \\
  & \;\;\;\; +\frac{n}{2}\sum_j \log(\omega_{Tjj}) - \frac{n}{2}\Esp\left[\Esp\left[ Tr(Z^T Z\Omega_T ) \,\middle\vert\,  Z_O,T\right] \,\middle\vert\,  Y\right]
\end{align*} 

\section{EM algorithm: M step}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Appendix}

\subsection{Generalities}


\subsubsection{Reminder}
Remind that:
\begin{itemize}
\item if $x\sim\mathcal{N}(m, \Sigma)$, then
$\Esp[x^TAx] = Tr(A\Sigma) + m^TAm$
\item if Y and X are Gaussian, $Y|X \sim \mathcal{N}(\mu_Y+\Sigma_{YX}\Sigma_{XX}^{-1}(x-\mu_X) , \Sigma_{YY} - \Sigma_{YX}\Sigma_{XX}^{-1}\Sigma_{XY})$\\
If Y and X are also centered then $\mu_{Y|X} = \Sigma_{YX}\Sigma_{XX}^{-1} X$
\end{itemize}


\subsubsection{Gaussian tree-structured variable}
When $Y$ is tree-structured:
$$ p(Y|T) = \prod_i  p(Y_i|T) \prod_{jk\in T} \underbrace{\psi_{jk}(Y_j,Y_k)}_{\text{emp. mutual  information}}$$

If $Y|T$ is also Gaussian:

$$\log(p(Y|T)) = -\frac{n}{2}\log(|\Sigma_T|) - \frac{1}{2} \sum_i\sum_{jk\in T} Y_{ij} \Omega_{jk} Y_{ik}$$

During the E step of the EM we need to compute $\Esp[Y^T\Omega Y|Y_O]$
\subsubsection{General considerations toward computation}
\begin{align*}
 \Esp[Y^T\Omega Y|Y_O] &=\Esp\left[\sum_{jk\in T } Y_j\Omega_{jk}Y_k|Y_O\right]&\\
& = \sum_{jk\in O^2} Y_i\Omega_{jk} Y_k & \text{[OO]}\\
&+\sum_{jk \in H^2} \Esp[Y_j\Omega_{jj}Y_j|Y_O] & \text{[HH]} \\
&+2 \sum_{j\in O, k \in H} \Esp(Y_j\Omega_{jk} Y_k |Y_O) & \text{[OH]}\\
\end{align*}

\paragraph{[OO]} We know everyone
\paragraph{[HH]} There are still the quadratic terms to compute. 
$$ \Omega_{kk} \Esp[Y_k^2|Y_O] = \Omega_{kk} \left( \Esp [Y_k|Y_O]^2 + \mathds{V}(Y_k|Y_O)\right)$$

\paragraph{[OH]}$$ Y_j\Omega_{jk}\Esp[Y_k|Y_O]$$

\subsubsection{Schur's complement}

\[
 \Sigma=
  \left( {\begin{array}{cc}
  K_O &  K_{OH}\\\\
  K_{HO} & K_H
  \end{array} } \right)^{-1} =
  \left( {\begin{array}{cc}
  \Sigma_O =( K_O - K_{HO}K_H^{-1}K_{OH})^{-1} &  - \Sigma_O K_{OH}K_H^{-1}\\\\
 -K_H^{-1}K_{HO}\Sigma_O & K_H^{-1}+K_H^{-1}K_{OH}\Sigma_OK_{HO}K_H^{-1}
  \end{array} } \right)
  \]
\subsection{Computations}

For any function $f$ we have using the VEM for PLN:
$$\Esp(f(Z)|Y_O)  \approx \int f(Z) p(Z_H|Z_O)\tilde{p}(Z_O) dZ_H dZ_O$$
$$\Esp(f(Z|T)|Y_O)  \approx \int f(Z|T) p(T|Z_O,Z_H) p(Z_H|Z_O)\tilde{p}(Z_O) dT dZ_H dZ_O$$
\subsubsection{ function of Z}
\begin{align*}
\Esp(f(Z)|Y_O) &=\int f(Z) p(Z|Y_O) dZ\\
&=\int f(Z) p(Z_H|Z_O) p(Z_O|Y_O) dZ_H dZ_O\\
&\approx \int f(Z) p(Z_H|Z_O)\tilde{p}(Z_O) dZ_H dZ_O
\end{align*}


 Here we consider $f(Z) = Z^T\Omega Z$.
\begin{align*}
\widehat{\Esp}[f(Z)|Z_O] &= \tilde{\Esp}(Z_O^T\Omega_{OO}Z_O)\\
& +\tilde{\Esp}\left[(\Sigma_{HO}\Sigma_{OO}^{-1} Z_O)^T \Omega_{HO}Z_O)\right] +\tilde{\Esp}\left[(Z_O)^T \Omega_{OH} (\Sigma_{HO}\Sigma_{OO}^{-1} Z_O)\right]\\
&+ \tilde{\Esp}\left[\Esp_{Z_H|Z_O} [Z_H\Omega_{HH}Z_H]\right]
\end{align*}


\subsubsection{A function of $Z|T$}
\begin{align*}
 p(Z|T,Y_O) &= \frac{p(Z,T|Y_O)}{p(T|Y_O)}\\
 &= \frac{p(T|Z,Y_O) p(Z|Y_O)}{p(T|Y_O)}\\
 & \propto p(T|Z_O,Z_H) p(Z_H|Z_O) p(Z_O|Y_O)\\
 &\approx  p(T|Z_O,Z_H) p(Z_H|Z_O)  \tilde{p}(Z_O) 
\end{align*}
\begin{align*}
\Esp(f(Z|T)|Y_O) &=\int f(Z) p(Z|T,Y_O) dZ\\
&\approx \int f(Z) p(T|Z_O,Z_H)p(Z_H|Z_O)\tilde{p}(Z_O) dT dZ_H dZ_O
\end{align*}


\end{document}