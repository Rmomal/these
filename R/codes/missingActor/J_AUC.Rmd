---
title: "Comment sélectionner un modèle"
output: 
  html_document: 
    theme: cosmo
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
mytheme.dark <-function(legend){list= list(theme_light(), scale_color_brewer(legend,palette="Dark2"), scale_fill_brewer(legend,palette="Dark2"),
                                           theme(strip.background=element_rect(fill="gray50",colour ="gray50"),
                                                 plot.title = element_text(hjust = 0.5)))
return(list)}

seed_filtre=readRDS("/Users/raphaellemomal/these/R/codes/missingActor/SimResults/seed_filtre.rds")
seed_filtre=seed_filtre %>% mutate(filtre=as.factor(ifelse(filtre, "GEM", "VEM")))
```

Dans cet exemple on s'intéresse à la sélection de modèle pour un nombre d'acteur manquant fixé, c'est à dire choisir la meilleure initialisation parmi celles trouvées par sPCA. 

B est fixé à 500, et deux cas sont comparés : un cas facile (graine 1), et un cas qui semble difficile (graine 19). 

Pour chaque clique initiale, on a lancé VEMtree dans sa version basique et dans sa version GEM. L'atteinte ou non de la précision machine a été relevé pour chaque VEMtree.

# Avec la borne inf {.tabset}

## AUC

```{r }
seed_filtre %>% ggplot(aes( AUC,J))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed)+mytheme.dark("")
```

## PPVH
```{r}
seed_filtre %>% ggplot(aes( ppvh,J))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed)+mytheme.dark("")
```

# Avec `JPLN_Eg` {.tabset}

La variable `JPLN_Eg` stocke la partie de la borne inf de PLN évaluée avec l'espérance sous $g$ de $\Omega_{Tm}$ au lieu de $\Sigma_O^{-1}$, soit $JPLN_{Eg} = \frac{n}{2} (\log |E_g[\Omega_{Tm}]| - Tr(\Sigma_OE_g[\Omega_{Tm}))$.

## AUC

```{r}
seed_filtre %>% ggplot(aes(AUC, part_EspgOm))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed)+mytheme.dark("")+labs(y="JPLN_Eg")
```

## PPVH

```{r}
seed_filtre %>% ggplot(aes(ppvh, part_EspgOm))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+labs(y="JPLN_Eg")+
  facet_grid(filtre~seed)+mytheme.dark("")
```

#Différence entre `JPLN_Eg` et  `JPLN_SigmaO`  {.tabset}

```{r}
seed_filtre=seed_filtre %>% mutate(diffJPLN=part_SigO-part_EspgOm) 
seed_filtre %>% group_by(seed) %>% summarise(part_sigO = part_SigO[1]) %>% kable() %>% kable_styling()
```

## AUC

```{r} 
seed_filtre %>% ggplot(aes(AUC, diffJPLN))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  geom_hline(yintercept = 0, linetype="dashed", color="red", alpha=0.8)+
  facet_grid(filtre~seed)+mytheme.dark("")
```

## PPVH

```{r}
seed_filtre %>% ggplot(aes(ppvh, diffJPLN))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  geom_hline(yintercept = 0, linetype="dashed", color="red", alpha=0.8)+
  facet_grid(filtre~seed)+mytheme.dark("")
```

# Avec Delta{.tabset}

Delta est la différence entre $\Sigma_O^{-1}$ et $E_g[ \Omega_{Tm}] = P\Omega_m$. Plus Delta est petit, plus l'utilisation de PLN en amont de VEMtree est juste, c'est à dire que l'approximation est de bonne qualité.


```{r}

seed_filtre %>% dplyr::select(Delta,filtre,index,seed) %>% 
  spread(filtre,Delta) %>% 
  ggplot(aes(VEM, GEM))+geom_point()+facet_wrap(~seed)+geom_abline()+
  mytheme.dark("")+labs(title="Delta moins élevé dans le cas GEM")
```

##AUC

```{r}
seed_filtre %>% ggplot(aes( AUC,Delta))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed)+mytheme.dark("")
```

##PPVH

```{r}
seed_filtre %>% ggplot(aes( ppvh,Delta))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed)+mytheme.dark("")

```

Sur ces exemples Delta permet de beaucoup mieux séparer les bonnes estimations que la borne inf. Cependant choisir le modèle qui minimise Delta ne srait pas satisfaisant pour le premier exemple. On peut en revanche choisir le modèle avec la meilleure borne inf parmi ceux présentant une petite valeur de Delta.  


# Sous-sélection des bornes inf {.tabset}
## Par `JPLN_Eg`
```{r, echo=FALSE}
seed_filtre=seed_filtre %>% group_by(seed,filtre) %>% mutate(qdiff = quantile(diffJPLN,0.5),
                                                             gooddiff = diffJPLN<qdiff) %>% 
  ungroup()
```

###AUC

```{r}
seed_filtre %>% ggplot(aes( AUC,J, color=(gooddiff)))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed) + mytheme.dark("diffJPLN <q5(diffJPLN)")
```

###PPVH

```{r}
seed_filtre %>% ggplot(aes( ppvh,J, color=(gooddiff)))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed) + mytheme.dark("diffJPLN <q5(diffJPLN)")
```

## Par Delta
```{r, echo=FALSE}
seed_filtre=seed_filtre %>% group_by(seed,filtre) %>% mutate(medDelta = quantile(Delta,0.1),
                                                             goodDelta = Delta<medDelta) %>% 
  ungroup()

```

### AUC
```{r}
seed_filtre %>% ggplot(aes( AUC,J, color=(goodDelta)))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed) + mytheme.dark("Delta < q10(Delta)")
```

### PPVH

```{r}
seed_filtre %>% ggplot(aes( ppvh,J, color=(goodDelta)))+geom_point()+
  geom_vline(xintercept = 0.5, linetype="dashed", color="gray")+
  facet_grid(filtre~seed) + mytheme.dark("Delta < q10(Delta)")
```

 
# Courbes de saturation

```{r}
seed_filtre %>% dplyr::select(J, seed, filtre, index) %>% as_tibble() %>% group_by(seed, filtre) %>% 
  mutate(maxJ = purrr::map(index, function(x){max(J[1:x])})) %>% unnest() %>% ungroup() %>%
  ggplot(aes(index, maxJ, color=filtre))+geom_point()+geom_line()+
  mytheme.dark("GEM:")+facet_wrap(~seed, scales="free_x")+
  labs(title="max of J among the x first cliques of sPCA with B=500", x="x")

cliques_spca19=readRDS("/Users/raphaellemomal/these/R/codes/missingActor/SimResults/cliques_spca19_10000.rds")
cliques_spca1=readRDS("/Users/raphaellemomal/these/R/codes/missingActor/SimResults/cliques_spca1_10000.rds")
plotdata=tibble(index=1:10000, cli19=cliques_spca19$cliqueList,cli1=cliques_spca1$cliqueList) %>% 
  mutate(seed1 = purrr::map(index, function(x){length(unique(cli1[1:x]))}),
         seed19 = purrr::map(index, function(x){length(unique(cli19[1:x]))})) %>% unnest() %>% dplyr::select(seed1, seed19,index) %>% gather(key, value, -index)

plotdata %>% 
  ggplot(aes(index, value, color=key))+geom_point(size=0.3)+geom_line(size=0.1)+ mytheme.dark("")+
  labs(title="Courbes de saturation des nouvelles cliques découvertes, pour B=1e+4", y="nombre de cliques uniques")

plotdata %>% 
  ggplot(aes(index, value, color=key))+geom_point(size=0.3)+geom_line()+ mytheme.dark("")+
  coord_cartesian(xlim=c(0,200), ylim=c(0,85))+
  labs(title="Zoom sur les 200 premiers échantillons bootstrap", y="nombre de cliques uniques")
```

