---
title: "Results"
output: 
  html_document:
    theme: cosmo
    toc: yes
    toc_float: yes
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(EMtree)
library(ggraph)
library(tidygraph)
library(tidyverse)
library(useful)
library(parallel)
library(ROCR)
library(ggridges)
library(reshape2)#for ggimage
library(gridExtra)
library(harrypotter)
library(kableExtra)
source("/Users/raphaellemomal/these/R/codes/missingActor/fonctions-V2.R")
source("/Users/raphaellemomal/these/R/codes/missingActor/feat_misAct.R")
source("/Users/raphaellemomal/these/R/codes/missingActor/VEM_tools.R")
source("/Users/raphaellemomal/these/R/codes/missingActor/modif_pkg.R")
source("/Users/raphaellemomal/these/R/codes/missingActor/fonctions-exactDet.R")

#"#4F5BD5",
pal<-c("#008080","#FA7E1E","#D62976","#358CC3")
mytheme.dark <-function(legend){list= list(theme_light(), #scale_color_hp(legend,option="Ravenclaw", discrete=TRUE, begin=0.1 ), #scale_fill_hp(legend,option="Ravenclaw", discrete=TRUE, begin=0.1 ),
                                           theme(strip.background=element_rect(fill="gray50",colour ="gray50"),
                                                 plot.title = element_text(hjust = 0.5)),
                                           scale_color_manual(legend, values=pal),
                                           scale_fill_manual(legend, values=pal))
return(list)}

# data
H=15
simus=list()
N=400
#paste0("/Users/raphaellemomal/these/R/codes/missingActor/SimResults/15nodes_exact_SH_F/SF_seed",seed,".rds")
 
simus=readRDS("/Users/raphaellemomal/these/R/codes/missingActor/SimResults/simus_V2_400_4init.rds")
badseeds=which(do.call(rbind, lapply(simus, function(seed){
  length(seed)
}))!=4)
if(length(badseeds)!=0) simus=simus[-badseeds]
N=length(simus)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
```


# Graphs générés

La table misAct rassemble des charactéristiques calculées sur chacun des graphes générées. 

- nH : nombre de voisins de l'acteur manquant
- mean.cpH : moyenne des corrélations partielles sortantes de l'acteur manquant
- mean.vv : nombre moyen de voisins des voisins de l'acteur manquant
- max.maxDeg : degré maximal parmi les voisins des voisins de l'acteur manquant
- mean.maxDeg : moyenne des degrés maximaux des voisins de voisins de l'acteur manquant
- mean.btw : moyenne des betweenness des voisins de l'acteur manquant
- btwH : betweenness de l'acteur manquant.

```{r, cache=FALSE}
misAct=build_misAct(simus, H=15)
misAct[1:6,] %>% kable %>% kable_styling()
```



Les résultats sont résumés en regroupant les graphes par l'influence de leur acteur manquant :

- minor : l'acteur manquant est lié à moins du tiers des noeuds ($nH<5$)
- medium : l'acteur manquant est lié à entre le tiers et la moitié des noeuds ( $5 \leq nH < 7$)
- major : l'acteur manquant est lié à plus de la moitié des noeuds ($nH \geq 7$)


```{r}
misAct=misAct %>% mutate(influence=unlist(purrr::map(nH, function(x){
  if(x<=5) res="Minor"
  if(x>5 & x<=7) res="Medium"
  if(x>7) res="Major"
  return(res)})))

misAct %>% group_by(influence) %>% summarise(count=n())%>% kable %>% kable_styling()
```


# Convergence de VEMtree

Tous les VEMtree ont convergé, mais pas de la même manière. L'algo VEMtree a trois critères d'arrêt :

- W et Omega convergent,
- la borne inférieure converge,
- maxIter a été atteint.

Donc VEMtree peut s'être arrêté du fait de la borne inf indépendemment de la convergence sur les paramètres W et Omega. Dans ce qui suit, on voit que maxIter (qui vaut 200) n'a jamais été atteint, et que lorsque c'est la convergence de J qui permet l'arrêt de l'algorithme, Omega a convergé mais pas W.

```{r}

# nb de stops par J au lieu des paramètres : 
stopJ=do.call(rbind, lapply(simus, function(graine){
  diffUpsi = tail(graine$VEM_1$features$diffUpsi,1)
  return( diffUpsi>1e-3)
}))
nb.stopJ = sum(stopJ)

finalIter=do.call(rbind, lapply(simus, function(graine){
  finalIter=graine$VEM_1$finalIter
}))
summary(finalIter)
which(finalIter==100)
plotVEM(simus[[45]]$VEM_1$Pg,simus[[45]]$G,r=1,seuil=0.5)
```

# Réseau et position de l'acteur manquant {.tabset}

La qualité d'inférence est évaluée avec l'AUC, la PPV (TP/(TP+FP)) et le TPR (TP/(TP+FN)) des arêtes incluant l'acteur manquant, notés PPVH et TPRH. Ces valeurs sont calculées pour chaque graphes, et les proportion de valeurs supérieures à 0.8 sont mises en liens avec le nombre de voisins nH de l'acteur manquant.

```{r}
Qual<-do.call(rbind, lapply(simus, function(seed){
  Pg=seed$VEM_1$Pg
  G=seed$G
  auc=round(auc(pred = Pg, label = G),4)
  H=15
  ppvh=accppvtpr(Pg,G,h=H,seuil=0.5)[5]
  tprh=accppvtpr(Pg,G,h=H,seuil=0.5)[8]
  return(data.frame(auc=auc,ppvh=ppvh,tprh=tprh))
})) %>% as_tibble()
Qual=Qual %>% mutate(seed = (1:N), nH =misAct$nH, influence=misAct$influence)
 
# Qual %>% group_by(nH) %>% summarise( count=n(),auc.prop80 = round(sum(auc>0.8)*100/count, 1), pvh.prop80 = round(sum(ppvh>0.8)*100/count, 1))%>% kable() %>% kable_styling()

Qual %>% group_by(influence) %>% 
  summarise(count=n(), med.auc=round(median(auc), 2),
            auc.prop50 = round(sum(auc>0.5)*100/count, 1))%>% 
  kable() %>% kable_styling()
Qual %>% group_by(influence) %>% summarise( count=n(), med.ppvh=round(median(ppvh, na.rm=TRUE),2), med.tprh=round(median(tprh),2), ppvh.prop50 = round(sum(ppvh>0.5, na.rm=TRUE)*100/count, 1),tprh.prop50 = round(sum(tprh>0.5)*100/count, 1))%>% 
  kable() %>% kable_styling()
```

## Boxplots 
```{r}
p=Qual %>%  rename(AUC=auc, PPVH=ppvh, TPRH=tprh) %>%  gather(key, value, -nH,  -influence, -seed) %>% 
ggplot(aes(key, value, color=key, fill=key))+geom_boxplot(alpha=0.3)+
  facet_grid(~as.factor(influence))+mytheme.dark("")+theme(axis.text.x = element_blank(),
                                                           legend.position = "bottom")+
  labs(x="", y="")
ggsave(filename = "simu_results.png", plot = p,
       path ="/Users/raphaellemomal/these/R/images/", width = 5, height = 4)

```

## Densities
```{r}
Qual %>% gather(key, value, -nH,  -influence, -seed) %>% 
  ggplot(aes(value, key, color=key, fill=key))+geom_density_ridges(alpha=0.3)+
  facet_grid(~as.factor(influence))+mytheme.dark("")+
  labs(x="", y="", title="Inference quality and influence of the missing actor")
```

VEMtree was unable to infer the missing actor in some case of major influence:

```{r}
c(Qual[(Qual$influence=="major" & Qual$ppvh< 0.5), "seed"])
```

## AUC vs PPVH

```{r}
Qual %>%
  ggplot(aes(auc, ppvh, color=influence, fill=influence))+geom_vline(xintercept = 0.5, color="gray")+
  geom_hline(yintercept = 0.5, color="gray")+geom_point()+
  facet_grid(~as.factor(influence))+mytheme.dark("")+
  labs(x="AUC", y="PPVH", title="")
```

## AUC vs TPRH

```{r}
Qual %>%
  ggplot(aes(auc, tprh, color=influence, fill=influence))+geom_vline(xintercept = 0.5, color="gray")+
  geom_hline(yintercept = 0.5, color="gray")+geom_point()+
  facet_grid(~as.factor(influence))+mytheme.dark("")+
  labs(x="AUC", y="TPRH", title="")
```


## PPVH vs TPRH

```{r}
Qual %>%
  ggplot(aes(ppvh, tprh, color=influence, fill=influence))+geom_vline(xintercept = 0.5, color="gray")+
  geom_hline(yintercept = 0.5, color="gray")+geom_point()+
  facet_grid(~as.factor(influence))+mytheme.dark("")+
  labs(x="PPVH", y="TPRH", title="")
```

# Reconstruction de l'acteur manquant

La reconstruction de l'acteur manquant est évaluée par la corrélation entre le vecteur latent gaussien d'origine $Z_H$, et le vecteur des moyennes inférées $M_H$.

```{r, warning=FALSE}
cor_UHMH=do.call(rbind, lapply(simus, function(graine){
  UH=graine$UH
  MH = graine$VEM_1$M[,H]
  return(cor(UH, MH))
}))
datacor=data.frame(corUM=abs(cor_UHMH), nH=misAct$nH, influence=misAct$influence) 
datacor%>% 
  group_by(influence) %>% summarize(m.cor=round(mean(corUM),2), sd.cor=round(sd(corUM),2),prop50 = round(100*sum(corUM>0.5)/n(),1)) %>% kable() %>% kable_styling()
 
datacor %>% ggplot(aes(corUM, color=influence, fill=influence))+
  geom_histogram( alpha=0.3,)+mytheme.dark("")+facet_wrap(~influence)+
  guides(color=FALSE, fill=FALSE)+labs(x="",y="", title="Absolute correlation between initial ZH and estimated MH")

```

VEMtree was unable to reconstruct missing actor in some major influence cases :
```{r}
which(datacor$influence=="major" & datacor$corUM < 0.5)
```

# Pourquoi plusieurs groupes {.tabset}
Etude de J, Jcor, Icl et diffJPLN en fonction de AUC, PPVH et corZM

```{r, warning=FALSE}
J=do.call(rbind, lapply(simus, function(graine){
  tail(graine$VEM_1$lowbound$J,1)
}))
penT=do.call(rbind, lapply(simus, function(graine){
  pen_T=-( 0.5*sum( graine$VEM_1$Pg * log(graine$VEM_1$Wg+(graine$VEM_1$Wg==0)) ) - logSumTree(graine$VEM_1$Wg)$det )
  return(pen_T)
}))
Jcor_diff=do.call(rbind, lapply(simus, function(graine){
  getJcor(graine$VEM_1,14)
}))
data=data.frame(J,penT, Jcor_diff,auc=Qual$auc,ppvh= Qual$ppvh,tprh=Qual$tprh, corZM=datacor$corUM, influence=Qual$influence) %>% as_tibble()
```


## AUC

```{r}
data %>% gather(key, value, -influence, -auc, -ppvh,-tprh,-corZM) %>% 
  ggplot(aes(auc, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~key, scales="free_y")+mytheme.dark("")

data %>% gather(key, value, -influence, -auc, -ppvh,-tprh,-corZM) %>% filter(key=="diff") %>% 
  ggplot(aes(auc, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+
  labs(y="diffJPLN")

data %>% gather(key, value, -influence, -auc, -ppvh,-tprh,-corZM) %>% filter(key=="J") %>% 
  ggplot(aes(auc, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+
  labs(y="J")

data %>% gather(key, value, -influence, -auc, -ppvh,-tprh,-corZM) %>% filter(key=="Jcor") %>% 
  ggplot(aes(auc, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+
  labs(y="Jcor")


data %>% mutate(ICL = Jcor-penT) %>%   
  ggplot(aes(auc, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+
  labs(y="ICL.Jcor")

data %>% mutate(ICL = J-penT) %>%   
  ggplot(aes(auc, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+
  labs(y="ICL.J")

```

## PPVH


```{r}
data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% 
  ggplot(aes(ppvh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~key, scales="free_y")+mytheme.dark("")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="diff") %>% 
  ggplot(aes(ppvh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="diffJPLN")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="J") %>% 
  ggplot(aes(ppvh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="J")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="Jcor") %>% 
  ggplot(aes(ppvh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="Jcor")


data %>% mutate(ICL = Jcor-penT) %>%   
  ggplot(aes(ppvh, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.Jcor")

data %>% mutate(ICL = J-penT) %>%   
  ggplot(aes(ppvh, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.J")

```

## corZM

```{r}
data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% 
  ggplot(aes(corZM, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~key, scales="free_y")+mytheme.dark("")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="diff") %>% 
  ggplot(aes(corZM, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="diffJPLN")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="J") %>% 
  ggplot(aes(corZM, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="J")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="Jcor") %>% 
  ggplot(aes(corZM, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="Jcor")


data %>% mutate(ICL = Jcor-penT) %>%   
  ggplot(aes(corZM, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.Jcor")

data %>% mutate(ICL = J-penT) %>%   
  ggplot(aes(corZM, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.J")

```

## TPRH

```{r}
data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% 
  ggplot(aes(tprh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~key, scales="free_y")+mytheme.dark("")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="diff") %>% 
  ggplot(aes(tprh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="diffJPLN")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="J") %>% 
  ggplot(aes(tprh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="J")

data %>% gather(key, value, -influence, -auc, -ppvh,-corZM,-tprh) %>% filter(key=="Jcor") %>% 
  ggplot(aes(tprh, value, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="Jcor")


data %>% mutate(ICL = Jcor-penT) %>%   
  ggplot(aes(tprh, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.Jcor")

data %>% mutate(ICL = J-penT) %>%   
  ggplot(aes(tprh, ICL, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")+labs(y="ICL.J")

```


# Caractéristiques des graphes {.tabset}

```{r}
data=data.frame(J,auc=Qual$auc,ppvh= Qual$ppvh,corZM=datacor$corUM, influence=Qual$influence, max.maxDeg=misAct$max.maxDeg,mean.btw=misAct$mean.btw, btwH=misAct$btwH, tprh=Qual$tprh, mean.maxDeg=misAct$mean.maxDeg, mean.vv=misAct$mean.vv, mean.cpH=misAct$mean.cpH, nH=misAct$nH) %>% as_tibble()
```

## J et Jcor

```{r}
data  %>% 
  ggplot(aes(J, btwH, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(J, mean.btw, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(J, max.maxDeg, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")

data  %>% 
  ggplot(aes(Jcor, btwH, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(Jcor, mean.btw, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(Jcor, max.maxDeg, color=influence))+ geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")

```

## AUC

```{r}

data  %>% 
  ggplot(aes(auc, as.factor(nH), color=influence,fill=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_density_ridges(stat="binline",bins=30,draw_baseline=FALSE, alpha=0.8) +mytheme.dark("")
data  %>% 
  ggplot(aes(auc, btwH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(auc, mean.btw, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(auc, max.maxDeg, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")

```

## PPVH

```{r}
data  %>% 
  ggplot(aes(ppvh, nH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+mytheme.dark("")
data  %>% 
  ggplot(aes(ppvh, btwH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(ppvh, mean.btw, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(ppvh, max.maxDeg, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")

```

## corZM

```{r}
data  %>% 
  ggplot(aes(corZM, as.factor(nH), color=influence,fill=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_density_ridges(stat="binline",bins=30,draw_baseline=FALSE, alpha=0.8) +mytheme.dark("")

data  %>% 
  ggplot(aes(corZM, nH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")
data  %>% filter(nH==6) %>% 
  ggplot(aes(corZM, btwH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")
data  %>% filter(nH==7) %>% 
  ggplot(aes(corZM, mean.btw, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")
data   %>% filter(nH==6) %>% 
  ggplot(aes(corZM, max.maxDeg, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")

data  %>% filter(nH==6) %>% 
  ggplot(aes(corZM, mean.vv, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")
data  %>% 
  ggplot(aes(corZM, mean.cpH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data   %>% filter(nH==6) %>% 
  ggplot(aes(corZM, mean.maxDeg, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+mytheme.dark("")


```

## TPRH

```{r}
data  %>% 
  ggplot(aes(tprh, nH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point() +mytheme.dark("")
data  %>% 
  ggplot(aes(tprh, btwH, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(tprh, mean.btw, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")
data  %>% 
  ggplot(aes(tprh, max.maxDeg, color=influence))+geom_vline(xintercept = 0.5, color="gray")+geom_point()+facet_wrap(~influence, scales="free_y")+mytheme.dark("")

```

