---
title: "ArretVEM"
output: 
  html_document:
    toc: true
    toc_float: true
---

# Initialization

```{r, echo=FALSE, message=FALSE, warning=FALSE }
library(EMtree)
library(PLNmodels)
library(ggraph)
library(tidygraph)
library(tidyverse)
library(mvtnorm)
library(useful)
library(mclust)
library(MASS)
library(ROCR)
library(reshape2)#for ggimage
library(gridExtra)
library(kableExtra)

source("/Users/raphaellemomal/these/R/codes/missingActor/fonctions-missing.R")
#source("/home/mmip/Raphaelle/these/R/codes/missingActor/fonctions-missing.R")
mytheme.light <- list(theme_light(), scale_color_brewer("",palette="Set3"),guides(color=FALSE),
                      theme(strip.background=element_rect(fill="gray50",colour ="gray50"),
                            plot.title = element_text(hjust = 0.5)))

mytheme.dark <- list(theme_light(), scale_color_brewer("",palette="Dark2"),
                     theme(strip.background=element_rect(fill="gray50",colour ="gray50"),
                           plot.title = element_text(hjust = 0.5)))
# mypal<-c(brewer.pal(3, "Blues"),brewer.pal(3, "Reds"),brewer.pal(3, "Greens"))
# mypal<-c(brewer.pal(8, "Dark2"),"blue","red")
mytheme <- list(theme_light(), scale_fill_brewer("",palette="Dark2"),#scale_colour_hp_d(option = "RavenClaw", name = ""), #scale_color_manual("",values=mypal),
                theme(strip.background=element_rect(fill="gray50",colour ="gray50"),
                      plot.title = element_text(hjust = 0.5)))

# simu parameters
set.seed(2) # mauvais 2, 4, 5 on a 2 lié à plein de gens donc pas trouvé et mauvais precrec H,
# 6 pas assez de voisins
n=200
p=14
r=1
type="scale-free"
plot=TRUE

################
#----- DATA
# simulate graph and omega, then sigma0 and finally counts
data=data_from_scratch(type = type,p = p+r,n = n,signed = FALSE,prob = 5/p,v = 0)
omega=data$omega
hidden=which(diag(omega)%in%sort(diag(omega), decreasing = TRUE)[1:r])[1:r] # on cache les r plus gros
trueClique=which(omega[hidden,-hidden]!=0)
print(trueClique)
if(plot){
  G=draw_network(1*(omega==1),groupes=1*(diag(omega)==diag(omega)[hidden][1]), 
                 layout="nicely",curv=0,nb=2,pal="black",nodes_label =1:(p+r))$G
  print(G)
}
Kh  <- omega[hidden,hidden]
Ko  <- omega[-hidden,-hidden]
Koh <- omega[-hidden,hidden]
Km  <- Ko - Koh %*%solve(Kh)%*% t(Koh)
sigmaO=solve(Km)

counts=generator_PLN(sigmaO,covariates = NULL,n=n)

ome_init=omega[c(setdiff(1:(p+r), hidden), hidden),c(setdiff(1:(p+r), hidden), hidden)] #ome is for testing
ome=ome_init
diag(ome)=0
####################
#----- PLN on counts
# optimization of theta and h(Z_O)
#remotes::install_github("jchiquet/PLNmodels@dev")

PLNfit<-PLN(counts~1)
MO<-PLNfit$var_par$M # MiO = ith row of MO
SO<-PLNfit$var_par$S # SiO = diag(ith row of SO)
sigma_obs=PLNfit$model_par$Sigma
plot(sigma_obs,sigmaO)

####################
#-----  Initialisation
# Tree
O=1:p
Wg_init <- matrix(1, p+r, p+r); diag(Wg_init) = 0; Wg_init =Wg_init / sum(Wg_init)
W_init <- matrix(1, p+r, p+r); diag(W_init) = 0; W_init =W_init / sum(W_init)
W_init[O,O] <- EMtree_corZ(cov2cor(sigma_obs),n = n,maxIter = 20)$edges_weight

# Z
# etude de la quantité de bruit à privilégier:
# B=30 ; coeff=seq(0.1,2,0.5)
# test=lapply(coeff,function(c){
#   res=cbind( data.frame( t(sapply(1:B, function(x){
#     init.mclust(sigma_obs,title="Sigma",
#                 trueClique = trueClique,n.noise=round(p*c))$FPN
#   }))),c)
# })
# test=do.call(rbind,test)
# colnames(test)=c("FN","FP","coeff")
# test %>% mutate(nul = (FN==1 & FP==0)) %>% filter(!nul) %>% dplyr::select(-nul) %>%
#   gather(FNP,value,-coeff) %>%
#   ggplot(aes(as.factor(coeff),value,fill=FNP))+geom_boxplot()+mytheme.light
# 
# test %>% mutate(nul = (FN==1 & FP==0)) %>% filter(!nul) %>% dplyr::select(-nul) %>%
#   group_by(coeff) %>% summarise(sumFP=sum(FP), sumFN=sum(FN), sum=sum(FP+FN))
```


Example of clique found:

```{r, echo=FALSE}
init.first<-init.mclust((cov2cor(sigma_obs)),title="Sigma",
                        trueClique = trueClique,n.noise=1,plot = TRUE)$init
for(i in 1:20){
  init.new= init.mclust((cov2cor(sigma_obs)),title="Sigma",
                        trueClique = trueClique,n.noise=1,plot = FALSE)$init
  if(length(init.new)>length(init.first)) init.first<-init.new
}
Opt.init=init.first
N=setdiff(1:p,trueClique)
FP=sum(Opt.init%in%N)/length(N)
FN=sum(setdiff(1:p,Opt.init)%in%trueClique)/length(trueClique)
data.frame(FP=FP, FN=FN) %>% kable() %>% kable_styling(bootstrap_options = "striped",full_width = F, position = "float_right")
```

The biggest clique found in 20 tries yields the following FN and FP values.
```{r}
Opt.init
trueClique
```


```{r, echo=FALSE}

initial.param<-initEM(sigma_obs,n=n,cliqueList = list(Opt.init),cst=1.05, pca=TRUE) # quick and dirty modif for initEM to take a covariance matrix as input
omega_init=initial.param$K0
sigma_init=initial.param$Sigma0

pr=prcomp(t(counts[,Opt.init]),scale. = FALSE)
MHinit = matrix(pr$rotation[,1]*pr$sdev[1],nrow=n,ncol=r)

```


# Until convergence, maxIter=30

```{r, echo=FALSE,message=FALSE, warning=FALSE, results=FALSE}
alpha=seq(1,0.6, -0.1)
eps=c(1e-4,1e-3,1e-2,1e-1)

models<-lapply(alpha, function(a){
  lapply(eps, function(ep){
    VEMtree(counts,MO,SO,MH=MHinit,omega_init,W_init,Wg_init, eps=ep, 
            alpha=a,
            maxIter=30, plot=FALSE,vraiOm=ome_init,
            condTrack=FALSE,print.hist=FALSE)
  })
})


Lowbounds=do.call(rbind, do.call(rbind,lapply(seq_along(models), function(a){
  lapply(seq_along(models[[a]]), function(ep){
    models[[a]][[ep]]$lowbound %>% dplyr::select(J,parameter) %>% rowid_to_column() %>%  
      mutate(alpha=alpha[a], eps=eps[ep])
  })
})))

precrec=do.call(rbind, do.call(rbind,lapply(seq_along(models), function(a){
  lapply(seq_along(models[[a]]), function(ep){
    probs=models[[a]][[ep]]$Pg
    values=courbes_seuil(probs =probs,omega = ome,h = 15,seq_seuil = seq(0,1,0.01))
    values %>% mutate(crit = PPV+TPR) %>% filter(crit==max(crit, na.rm=TRUE)) %>%
      summarise(mins=min(seuil), maxs=max(seuil), PPV=max(PPV), PPVO=max(PPVO),PPVH=max(PPVH), 
                TPR=max(TPR),TPRO=max(TPRO),TPRH=max(TPRH)) %>% 
      mutate(alpha=alpha[a], eps=eps[ep])
  })
})))
```


## Lower bounds 
```{r, fig.height=10, fig.width=10 , echo=FALSE}

Lowbounds %>%
  ggplot(aes(rowid,J))+geom_point(aes(color=as.factor(parameter)), size=3)+geom_line()+
  facet_grid(alpha~eps,scales="free_x",labeller = label_both )+
  labs(x="Iter x 4",y="", title="Lower bound as a function of alpha and epsilon")+mytheme+
  scale_color_discrete("")
```

As epsilon decreases, a smaller alpha is needed to reach a stable maximal value of the lower bound.

## Precision Recall qualities

Threshold values which maximizes PPV+TPR, and corresponding values for H and O parts.

```{r, echo=FALSE}
precrec %>% dplyr::select(-mins,-maxs) %>% gather(key, value,-alpha, -eps) %>% 
  ggplot(aes(as.factor(eps),value, group=key, color=key))+geom_point()+geom_line()+
  facet_wrap(~alpha)+mytheme.dark+labs(x="epsilon",y="","Optimal precision recall quantities reached as alpha varies")
precrec %>%dplyr::select(-mins,-maxs) %>% gather(key,value, - eps, -alpha)%>%
    mutate(status=ifelse(substr(key,4,4)=="","all",substr(key,4,4))) %>% 
    mutate(key=substr(key,1,3)) %>%  spread(key,value) %>% 
    ggplot(aes(TPR,PPV,color=status))+coord_cartesian(xlim=c(0,1), ylim=c(0,1))+
    geom_rect(aes(xmin=0.5, xmax=1, ymin=0.5, ymax=1), fill="gray90", color="gray90",alpha=0.1)+
    geom_point()+  geom_line()+
    facet_grid(alpha~status)+mytheme.dark+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
precrec %>% dplyr::select(mins,maxs, alpha, eps) %>% gather(key, value,-alpha, -eps) %>% 
  ggplot(aes(as.factor(eps),value, group=key, color=key))+geom_point()+geom_line()+
  facet_wrap(~alpha )+mytheme.dark+labs(x="epsilon",y="threshold range",
                                        title="Optimal threshold range as alpha varies")
```

A rather small precision (epsilon of 1e-2) does not mean weaker performances.


# Stop at 2 iterations

```{r,echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
alpha=seq(1,0.6, -0.1)
eps=c(1e-4,1e-3,1e-2,1e-1)

models<-lapply(alpha, function(a){
  lapply(eps, function(ep){
    VEMtree(counts,MO,SO,MH=MHinit,omega_init,W_init,Wg_init, eps=ep, 
            alpha=a,
            maxIter=2, plot=FALSE,vraiOm=ome_init,
            condTrack=FALSE,print.hist=FALSE)
  })
})


Lowbounds=do.call(rbind, do.call(rbind,lapply(seq_along(models), function(a){
  lapply(seq_along(models[[a]]), function(ep){
    models[[a]][[ep]]$lowbound %>% dplyr::select(J,parameter) %>% rowid_to_column() %>%  
      mutate(alpha=alpha[a], eps=eps[ep])
  })
})))

precrec=do.call(rbind, do.call(rbind,lapply(seq_along(models), function(a){
  lapply(seq_along(models[[a]]), function(ep){
    probs=models[[a]][[ep]]$Pg
    values=courbes_seuil(probs =probs,omega = ome,h = 15,seq_seuil = seq(0,1,0.01))
    values %>% mutate(crit = PPV+TPR) %>% filter(crit==max(crit, na.rm=TRUE)) %>%
      summarise(mins=min(seuil), maxs=max(seuil), PPV=max(PPV), PPVO=max(PPVO),PPVH=max(PPVH), 
                TPR=max(TPR),TPRO=max(TPRO),TPRH=max(TPRH)) %>% 
      mutate(alpha=alpha[a], eps=eps[ep])
  })
})))
```


## Lower bounds 
```{r, fig.height=10, fig.width=10 , echo=FALSE}

Lowbounds %>%
  ggplot(aes(rowid,J))+geom_point(aes(color=as.factor(parameter)), size=3)+geom_line()+
  facet_grid(alpha~eps,scales="free_x",labeller = label_both )+
  labs(x="Iter x 4",y="", title="Lower bound as a function of alpha and epsilon")+mytheme+
  scale_color_discrete("")
```


## Precision Recall qualities


```{r, echo=FALSE}
precrec %>% dplyr::select(-mins,-maxs) %>% gather(key, value,-alpha, -eps) %>% 
  ggplot(aes(as.factor(eps),value, group=key, color=key))+geom_point()+geom_line()+
  facet_wrap(~alpha)+mytheme.dark+labs(x="epsilon",y="","Optimal precision recall quantities reached as alpha varies")

precrec %>%dplyr::select(-mins,-maxs) %>% gather(key,value, - eps, -alpha)%>%
    mutate(status=ifelse(substr(key,4,4)=="","all",substr(key,4,4))) %>% 
    mutate(key=substr(key,1,3)) %>%  spread(key,value) %>% 
    ggplot(aes(TPR,PPV,color=status))+coord_cartesian(xlim=c(0,1), ylim=c(0,1))+
    geom_rect(aes(xmin=0.5, xmax=1, ymin=0.5, ymax=1), fill="gray90", color="gray90",alpha=0.1)+
    geom_point()+  geom_line()+
    facet_grid(alpha~status)+mytheme.dark+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

precrec %>% dplyr::select(mins,maxs, alpha, eps) %>% gather(key, value,-alpha, -eps) %>% 
  ggplot(aes(as.factor(eps),value, group=key, color=key))+geom_point()+geom_line()+
  facet_wrap(~alpha )+mytheme.dark+labs(x="epsilon",y="threshold range",
                                        title="Optimal threshold range as alpha varies")
```

